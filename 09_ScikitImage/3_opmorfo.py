"""
Ejemplo Pr√°ctico: An√°lisis de Im√°genes M√©dicas - Detecci√≥n y An√°lisis de C√©lulas
===============================================================================

Este ejemplo demuestra c√≥mo las operaciones morfol√≥gicas se aplican en el mundo real
para el an√°lisis de im√°genes m√©dicas, espec√≠ficamente para:
1. Limpiar ruido en im√°genes de microscop√≠a
2. Separar c√©lulas que est√°n toc√°ndose
3. Rellenar huecos en estructuras celulares
4. Detectar bordes y contornos de c√©lulas

Aplicaciones reales:
- Diagn√≥stico m√©dico automatizado
- Conteo autom√°tico de c√©lulas
- Detecci√≥n de anomal√≠as celulares
- An√°lisis de tejidos cancerosos
"""

import numpy as np
import matplotlib.pyplot as plt
from skimage import morphology, measure, segmentation, filters
from scipy import ndimage
import cv2


def crear_imagen_simulada_celulas():
    """
    Crea una imagen simulada que representa c√©lulas vistas bajo microscopio
    con ruido y artefactos t√≠picos de im√°genes m√©dicas reales
    """
    # Crear imagen base de 400x400 p√≠xeles
    img = np.zeros((400, 400), dtype=np.uint8)

    # Crear c√©lulas circulares de diferentes tama√±os
    centros_celulas = [
        (100, 100, 30),  # (x, y, radio)
        (200, 150, 25),
        (320, 80, 35),
        (150, 250, 28),
        (300, 280, 32),
        (80, 320, 22),
        (250, 300, 26),
    ]

    # Dibujar c√©lulas como c√≠rculos
    for x, y, radio in centros_celulas:
        cv2.circle(img, (x, y), radio, 255, -1)

    # Crear algunas c√©lulas que se tocan (problema com√∫n en microscop√≠a)
    cv2.circle(img, (160, 180), 25, 255, -1)
    cv2.circle(img, (180, 190), 23, 255, -1)

    # A√±adir n√∫cleos dentro de las c√©lulas
    for x, y, radio in centros_celulas:
        cv2.circle(img, (x + 5, y - 3), radio // 3, 128, -1)

    # A√±adir ruido t√≠pico de im√°genes m√©dicas
    ruido = np.random.normal(0, 15, img.shape).astype(np.int16)
    img = np.clip(img.astype(np.int16) + ruido, 0, 255).astype(np.uint8)

    # A√±adir algunos p√≠xeles dispersos (artefactos)
    for _ in range(50):
        x, y = np.random.randint(0, 400, 2)
        img[y, x] = 255

    # Crear algunos huecos en las c√©lulas
    for x, y, _ in centros_celulas[:3]:
        cv2.circle(img, (x - 8, y + 5), 3, 0, -1)

    return img


def procesar_imagen_medica(imagen_original):
    """
    Aplica una serie de operaciones morfol√≥gicas para mejorar
    la imagen m√©dica y prepararla para an√°lisis
    """
    # Binarizar la imagen usando umbralizaci√≥n de Otsu
    umbral = filters.threshold_otsu(imagen_original)
    imagen_binaria = imagen_original > umbral

    # PASO 1: ELIMINACI√ìN DE RUIDO
    # Usar opening para eliminar p√≠xeles aislados y ruido peque√±o
    elemento_estructural_peque√±o = morphology.disk(2)
    sin_ruido = morphology.opening(imagen_binaria, elemento_estructural_peque√±o)

    # PASO 2: RELLENAR HUECOS
    # Usar closing para rellenar peque√±os huecos dentro de las c√©lulas
    elemento_estructural_medio = morphology.disk(4)
    sin_huecos = morphology.closing(sin_ruido, elemento_estructural_medio)

    # PASO 3: SEPARACI√ìN DE C√âLULAS QUE SE TOCAN
    # Usar erosi√≥n seguida de watershed para separar objetos conectados
    erodida = morphology.erosion(sin_huecos, morphology.disk(3))

    # Encontrar marcadores para watershed
    distancia = ndimage.distance_transform_edt(erodida)
    # Usar peak_local_max con min_distance
    from skimage.feature import peak_local_max

    coordenadas_maximos = peak_local_max(
        distancia, min_distance=20, threshold_abs=0.3 * distancia.max()
    )

    # Crear imagen de marcadores
    marcadores_img = np.zeros_like(distancia, dtype=bool)
    marcadores_img[tuple(coordenadas_maximos.T)] = True
    marcadores = measure.label(marcadores_img)

    # Aplicar watershed para separar c√©lulas
    celulas_separadas = segmentation.watershed(-distancia, marcadores, mask=sin_huecos)

    return {
        "original": imagen_original,
        "binaria": imagen_binaria,
        "sin_ruido": sin_ruido,
        "sin_huecos": sin_huecos,
        "separadas": celulas_separadas > 0,
        "etiquetadas": celulas_separadas,
    }


def analizar_celulas(imagen_etiquetada):
    """
    Realiza an√°lisis cuantitativo de las c√©lulas detectadas
    """
    propiedades = measure.regionprops(imagen_etiquetada.astype(int))

    resultados = {
        "num_celulas": len(propiedades),
        "areas": [prop.area for prop in propiedades],
        "perimetros": [prop.perimeter for prop in propiedades],
        "circularidades": [],
        "centroides": [prop.centroid for prop in propiedades],
    }

    # Calcular circularidad (4œÄ √ó √°rea / per√≠metro¬≤)
    for prop in propiedades:
        if prop.perimeter > 0:
            circularidad = 4 * np.pi * prop.area / (prop.perimeter**2)
            resultados["circularidades"].append(circularidad)
        else:
            resultados["circularidades"].append(0)

    return resultados


def detectar_bordes_celulares(imagen):
    """
    Usa operaciones morfol√≥gicas para detectar bordes de c√©lulas
    """
    # Convertir imagen booleana a enteros para poder hacer la resta
    imagen_int = imagen.astype(np.uint8)

    # Gradiente morfol√≥gico para detectar bordes
    dilatada = morphology.dilation(imagen_int)
    erodida = morphology.erosion(imagen_int)
    bordes = dilatada - erodida

    return bordes


def ejemplo_aplicaciones_especificas():
    """
    Ejemplos de aplicaciones espec√≠ficas de operaciones morfol√≥gicas
    en im√°genes m√©dicas
    """
    # Crear imagen base
    img = crear_imagen_simulada_celulas()

    # Binarizar
    umbral = filters.threshold_otsu(img)
    img_bin = img > umbral

    # Top-hat blanco: detectar peque√±as estructuras brillantes
    # √ötil para detectar micocalcificaciones en mamograf√≠as
    tophat_blanco = morphology.white_tophat(img, morphology.disk(10))

    # Top-hat negro: detectar peque√±as estructuras oscuras
    # √ötil para detectar vasos sangu√≠neos
    tophat_negro = morphology.black_tophat(img, morphology.disk(10))

    # Esqueletizaci√≥n: reducir estructuras a su forma m√°s simple
    # √ötil para an√°lisis de vasos sangu√≠neos o redes neuronales
    esqueleto = morphology.skeletonize(img_bin)

    return {
        "original": img,
        "tophat_blanco": tophat_blanco,
        "tophat_negro": tophat_negro,
        "esqueleto": esqueleto,
    }


def visualizar_resultados():
    """
    Funci√≥n principal que ejecuta todo el ejemplo y muestra los resultados
    """
    print("üî¨ AN√ÅLISIS DE IM√ÅGENES M√âDICAS CON OPERACIONES MORFOL√ìGICAS")
    print("=" * 65)

    # Crear imagen simulada
    imagen = crear_imagen_simulada_celulas()

    # Procesar la imagen
    resultados = procesar_imagen_medica(imagen)

    # Analizar c√©lulas
    analisis = analizar_celulas(resultados["etiquetadas"])

    # Detectar bordes
    bordes = detectar_bordes_celulares(resultados["separadas"])

    # Aplicaciones espec√≠ficas
    aplicaciones = ejemplo_aplicaciones_especificas()

    # Crear visualizaci√≥n
    fig, axes = plt.subplots(3, 3, figsize=(15, 15))
    fig.suptitle(
        "Operaciones Morfol√≥gicas en An√°lisis de Im√°genes M√©dicas", fontsize=16
    )

    # Fila 1: Proceso de limpieza
    axes[0, 0].imshow(resultados["original"], cmap="gray")
    axes[0, 0].set_title("1. Imagen Original\n(Microscop√≠a simulada)")
    axes[0, 0].axis("off")

    axes[0, 1].imshow(resultados["sin_ruido"], cmap="gray")
    axes[0, 1].set_title("2. Despu√©s de Opening\n(Ruido eliminado)")
    axes[0, 1].axis("off")

    axes[0, 2].imshow(resultados["sin_huecos"], cmap="gray")
    axes[0, 2].set_title("3. Despu√©s de Closing\n(Huecos rellenados)")
    axes[0, 2].axis("off")

    # Fila 2: Separaci√≥n y an√°lisis
    axes[1, 0].imshow(resultados["separadas"], cmap="gray")
    axes[1, 0].set_title("4. C√©lulas Separadas\n(Watershed)")
    axes[1, 0].axis("off")

    axes[1, 1].imshow(resultados["etiquetadas"], cmap="tab20")
    axes[1, 1].set_title(
        f"5. C√©lulas Etiquetadas\n({analisis['num_celulas']} c√©lulas detectadas)"
    )
    axes[1, 1].axis("off")

    axes[1, 2].imshow(bordes, cmap="gray")
    axes[1, 2].set_title("6. Bordes Detectados\n(Gradiente morfol√≥gico)")
    axes[1, 2].axis("off")

    # Fila 3: Aplicaciones espec√≠ficas
    axes[2, 0].imshow(aplicaciones["tophat_blanco"], cmap="gray")
    axes[2, 0].set_title("7. Top-hat Blanco\n(Estructuras peque√±as)")
    axes[2, 0].axis("off")

    axes[2, 1].imshow(aplicaciones["tophat_negro"], cmap="gray")
    axes[2, 1].set_title("8. Top-hat Negro\n(Vasos/canales)")
    axes[2, 1].axis("off")

    axes[2, 2].imshow(aplicaciones["esqueleto"], cmap="gray")
    axes[2, 2].set_title("9. Esqueletizaci√≥n\n(Estructura simplificada)")
    axes[2, 2].axis("off")

    plt.tight_layout()
    plt.show()

    # Mostrar estad√≠sticas del an√°lisis
    print("\nüìä RESULTADOS DEL AN√ÅLISIS:")
    print(f"‚Ä¢ C√©lulas detectadas: {analisis['num_celulas']}")
    print(f"‚Ä¢ √Årea promedio: {np.mean(analisis['areas']):.1f} p√≠xeles¬≤")
    print(f"‚Ä¢ √Årea m√≠nima: {np.min(analisis['areas']):.1f} p√≠xeles¬≤")
    print(f"‚Ä¢ √Årea m√°xima: {np.max(analisis['areas']):.1f} p√≠xeles¬≤")
    print(f"‚Ä¢ Circularidad promedio: {np.mean(analisis['circularidades']):.3f}")

    print("\nüè• APLICACIONES EN EL MUNDO REAL:")
    print("‚Ä¢ Diagn√≥stico de c√°ncer: Detectar c√©lulas anormales")
    print("‚Ä¢ Hematolog√≠a: Conteo autom√°tico de gl√≥bulos rojos/blancos")
    print("‚Ä¢ Cardiolog√≠a: An√°lisis de tejido card√≠aco")
    print("‚Ä¢ Neurolog√≠a: Estudio de neuronas y conexiones")
    print("‚Ä¢ Oftalmolog√≠a: An√°lisis de retina y vasos sangu√≠neos")
    print("‚Ä¢ Patolog√≠a: Clasificaci√≥n autom√°tica de tejidos")


def ejemplo_caso_clinico():
    """
    Simula un caso cl√≠nico real: detecci√≥n de c√©lulas cancerosas
    """
    print("\nü©∫ CASO CL√çNICO SIMULADO: Detecci√≥n de C√©lulas Anormales")
    print("=" * 60)

    # Crear imagen con c√©lulas normales y algunas anormales
    img = crear_imagen_simulada_celulas()

    # Procesar
    resultados = procesar_imagen_medica(img)
    analisis = analizar_celulas(resultados["etiquetadas"])

    # Clasificar c√©lulas bas√°ndose en √°rea y circularidad
    celulas_normales = 0
    celulas_sospechosas = 0

    for i, (area, circularidad) in enumerate(
        zip(analisis["areas"], analisis["circularidades"])
    ):
        # Criterios simplificados para ejemplo
        if area > 1000 and circularidad < 0.7:  # C√©lulas grandes e irregulares
            celulas_sospechosas += 1
            print(
                f"  ‚ö†Ô∏è  C√©lula {i + 1}: SOSPECHOSA (√Årea: {area:.0f}, Circularidad: {circularidad:.3f})"
            )
        else:
            celulas_normales += 1
            print(
                f"  ‚úÖ C√©lula {i + 1}: Normal (√Årea: {area:.0f}, Circularidad: {circularidad:.3f})"
            )

    print("\nüìã RESUMEN DEL DIAGN√ìSTICO:")
    print(f"‚Ä¢ C√©lulas normales: {celulas_normales}")
    print(f"‚Ä¢ C√©lulas sospechosas: {celulas_sospechosas}")

    if celulas_sospechosas > 0:
        print("‚Ä¢ RECOMENDACI√ìN: Requiere revisi√≥n por especialista")
    else:
        print("‚Ä¢ RECOMENDACI√ìN: Muestra dentro de par√°metros normales")


if __name__ == "__main__":
    # Ejecutar el ejemplo completo
    visualizar_resultados()
    ejemplo_caso_clinico()
